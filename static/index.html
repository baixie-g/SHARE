<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>g00j小站 - 文件共享系统</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- 导航栏 -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <h1>🏠 g00j小站</h1>
                </div>
                <div class="nav-menu">
                    <button @click="currentView = 'home'" :class="{'active': currentView === 'home'}">
                        🏡 首页
                    </button>
                    <button @click="currentView = 'files'" :class="{'active': currentView === 'files'}">
                        📂 文件管理
                    </button>
                    <button v-if="user && user.role === 'admin'" @click="currentView = 'monitor'" 
                            :class="{'active': currentView === 'monitor'}">
                        📊 系统监控
                    </button>
                    <button v-if="user && user.role === 'admin'" @click="currentView = 'admin'" 
                            :class="{'active': currentView === 'admin'}">
                        ⚙️ 管理面板
                    </button>
                    <button v-if="!user" @click="showLoginModal = true" class="login-btn">
                        🔑 登录
                    </button>
                    <div v-if="user" class="user-menu">
                        <span>👤 {{ user.username }}</span>
                        <button @click="logout" class="logout-btn">🚪 登出</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 首页视图 -->
            <div v-if="currentView === 'home'" class="home-view">
                <div class="welcome-section">
                    <h2>🎉 欢迎来到 g00j小站</h2>
                    <p>轻量级文件共享平台，支持视频播放、文档阅读、文件管理等完整功能</p>
                </div>
                
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">📁</div>
                        <div class="stat-info">
                            <h3>{{ totalFiles }}</h3>
                            <p>共享文件</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">👥</div>
                        <div class="stat-info">
                            <h3>{{ onlineUsers }}</h3>
                            <p>在线用户</p>
                        </div>
                    </div>
                    <div class="stat-card" v-if="systemStatus">
                        <div class="stat-icon">💾</div>
                        <div class="stat-info">
                            <h3>{{ parseFloat(systemStatus.disk_usage || 0).toFixed(1) }}%</h3>
                            <p>磁盘使用率</p>
                        </div>
                    </div>
                </div>

                <div class="recent-files">
                    <h3>📋 最新文件</h3>
                    <div class="file-grid">
                        <div v-for="file in recentFiles" :key="file.id" class="file-card">
                            <div class="file-icon">{{ getFileIcon(file.category) }}</div>
                            <div class="file-info">
                                <h4>{{ file.filename }}</h4>
                                <p>{{ formatFileSize(file.size) }} · {{ formatDate(file.upload_time) }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件管理视图 -->
            <div v-if="currentView === 'files'" class="files-view">
                <div class="files-header">
                    <h2>📂 文件管理</h2>
                    <div class="files-actions">
                        <select v-model="currentCategory" @change="loadFiles">
                            <option value="">所有文件</option>
                            <option value="videos">视频文件</option>
                            <option value="images">图片文件</option>
                            <option value="documents">文档文件</option>
                            <option value="others">其他文件</option>
                        </select>
                        <button v-if="user" @click="showUploadModal = true" class="upload-btn">
                            📤 上传文件
                        </button>
                    </div>
                </div>

                <div class="files-list">
                    <div v-for="file in files" :key="file.id" class="file-item">
                        <div class="file-icon">{{ getFileIcon(file.category) }}</div>
                        <div class="file-details">
                            <h4>{{ file.filename }}</h4>
                            <p>{{ formatFileSize(file.size) }} · 上传者: {{ file.uploader }} · {{ formatDate(file.upload_time) }}</p>
                        </div>
                        <div class="file-actions">
                            <button @click="previewFile(file)" class="preview-btn">👁️ 预览</button>
                            <button v-if="user" @click="downloadFile(file)" class="download-btn">💾 下载</button>
                        </div>
                    </div>
                </div>

                <!-- 分页 -->
                <div v-if="pagination.pages > 1" class="pagination">
                    <button @click="changePage(pagination.page - 1)" :disabled="pagination.page <= 1">
                        ⬅️ 上一页
                    </button>
                    <span>第 {{ pagination.page }} 页 / 共 {{ pagination.pages }} 页</span>
                    <button @click="changePage(pagination.page + 1)" :disabled="pagination.page >= pagination.pages">
                        下一页 ➡️
                    </button>
                </div>
            </div>

            <!-- 系统监控视图 -->
            <div v-if="currentView === 'monitor' && user && user.role === 'admin'" class="monitor-view">
                <h2>📊 系统监控</h2>
                
                <div class="monitor-cards">
                    <div class="monitor-card">
                        <h3>💻 CPU 使用率</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" :style="{width: systemStatus.cpu_usage + '%'}"></div>
                        </div>
                        <p>{{ parseFloat(systemStatus.cpu_usage || 0).toFixed(1) }}%</p>
                    </div>
                    
                    <div class="monitor-card">
                        <h3>💾 内存使用率</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" :style="{width: systemStatus.memory_usage + '%'}"></div>
                        </div>
                        <p>{{ parseFloat(systemStatus.memory_usage || 0).toFixed(1) }}%</p>
                    </div>
                    
                    <div class="monitor-card">
                        <h3>🗂️ 磁盘使用率</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" :style="{width: systemStatus.disk_usage + '%'}"></div>
                        </div>
                        <p>{{ parseFloat(systemStatus.disk_usage || 0).toFixed(1) }}%</p>
                    </div>
                </div>

                <div class="processes-section">
                    <h3>🔄 进程列表</h3>
                    <div class="processes-controls">
                        <div class="search-bar">
                            <input v-model="processFilter" type="text" placeholder="🔍 搜索进程名..." class="search-input">
                        </div>
                        <div class="sort-controls">
                            <label>排序方式:</label>
                            <select v-model="processSortBy" @change="sortProcesses" class="sort-select">
                                <option value="cpu">CPU使用率 ⬇️</option>
                                <option value="memory">内存使用率 ⬇️</option>
                                <option value="name">进程名 ⬆️</option>
                                <option value="pid">PID ⬆️</option>
                                <option value="user">用户 ⬆️</option>
                            </select>
                        </div>
                        <button @click="loadProcesses" class="refresh-btn">🔄 刷新</button>
                    </div>
                    <div class="processes-table">
                        <div class="table-header process-header">
                            <span>PID</span>
                            <span>进程名</span>
                            <span>用户</span>
                            <span>状态</span>
                            <span>CPU%</span>
                            <span>内存%</span>
                            <span>内存(KB)</span>
                            <span>操作</span>
                        </div>
                        <div v-for="process in filteredProcesses" :key="process.pid" class="table-row process-row">
                            <span>{{ process.pid }}</span>
                            <span class="process-name">{{ process.name }}</span>
                            <span>{{ process.user }}</span>
                            <span :class="['status', process.status.toLowerCase()]">{{ process.status }}</span>
                            <span :class="['cpu-usage', getCpuClass(process.cpu)]">{{ process.cpu }}%</span>
                            <span :class="['memory-usage', getMemoryClass(process.memory)]">{{ process.memory }}%</span>
                            <span>{{ formatNumber(process.memory_kb) }}</span>
                            <span>
                                <button @click="killProcess(process.pid)" class="danger-btn">❌ 终止</button>
                            </span>
                        </div>
                        <div v-if="filteredProcesses.length === 0" class="no-processes">
                            🔍 没有找到匹配的进程
                        </div>
                    </div>
                </div>
            </div>

            <!-- 管理面板视图 -->
            <div v-if="currentView === 'admin' && user && user.role === 'admin'" class="admin-view">
                <h2>⚙️ 管理面板</h2>
                
                <div class="admin-sections">
                    <div class="admin-section">
                        <h3>👥 用户管理</h3>
                        <div class="admin-table">
                            <div class="table-header">
                                <span>ID</span>
                                <span>用户名</span>
                                <span>角色</span>
                                <span>注册时间</span>
                                <span>状态</span>
                                <span>操作</span>
                            </div>
                            <div v-for="user in adminUsers" :key="user.id" class="table-row">
                                <span>{{ user.id }}</span>
                                <span>{{ user.username }}</span>
                                <span>{{ user.role }}</span>
                                <span>{{ formatDate(user.created_at) }}</span>
                                <span>{{ user.active ? '活跃' : '禁用' }}</span>
                                <span>
                                    <button v-if="user.id !== 1" @click="deleteUser(user.id)" class="danger-btn">
                                        🗑️ 删除
                                    </button>
                                    <span v-else class="protected-user">系统管理员</span>
                                </span>
                            </div>
                        </div>
                        <button @click="loadAdminUsers" class="refresh-btn">🔄 刷新用户列表</button>
                    </div>

                    <div class="admin-section">
                        <h3>📁 文件管理</h3>
                        <div class="admin-table">
                            <div class="table-header">
                                <span>ID</span>
                                <span>文件名</span>
                                <span>分类</span>
                                <span>大小</span>
                                <span>上传者</span>
                                <span>上传时间</span>
                                <span>操作</span>
                            </div>
                            <div v-for="file in adminFiles" :key="file.id" class="table-row">
                                <span>{{ file.id }}</span>
                                <span>{{ file.filename }}</span>
                                <span>{{ file.category }}</span>
                                <span>{{ formatFileSize(file.size) }}</span>
                                <span>{{ file.uploader }}</span>
                                <span>{{ formatDate(file.upload_time) }}</span>
                                <span>
                                    <button @click="deleteAdminFile(file.id)" class="danger-btn">
                                        🗑️ 删除
                                    </button>
                                </span>
                            </div>
                        </div>
                        <button @click="loadAdminFiles" class="refresh-btn">🔄 刷新文件列表</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 登录模态框 -->
        <div v-if="showLoginModal" class="modal-overlay" @click="showLoginModal = false">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h3>🔑 用户登录</h3>
                    <button @click="showLoginModal = false" class="close-btn">✖️</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="login">
                        <div class="form-group">
                            <label>用户名:</label>
                            <input v-model="loginForm.username" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>密码:</label>
                            <input v-model="loginForm.password" type="password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="submit-btn">🚀 登录</button>
                            <button type="button" @click="showRegisterForm = true" class="text-btn">
                                还没有账户？点击注册
                            </button>
                        </div>
                    </form>

                    <form v-if="showRegisterForm" @submit.prevent="register" class="register-form">
                        <h4>📝 用户注册</h4>
                        <div class="form-group">
                            <label>用户名:</label>
                            <input v-model="registerForm.username" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>密码:</label>
                            <input v-model="registerForm.password" type="password" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="submit-btn">📋 注册</button>
                            <button type="button" @click="showRegisterForm = false" class="text-btn">
                                返回登录
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 文件上传模态框 -->
        <div v-if="showUploadModal" class="modal-overlay" @click="showUploadModal = false">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h3>📤 文件上传</h3>
                    <button @click="showUploadModal = false" class="close-btn">✖️</button>
                </div>
                <div class="modal-body">
                    <div class="upload-area" @drop="handleFileDrop" @dragover.prevent @dragenter.prevent>
                        <div class="upload-icon">📁</div>
                        <p>拖拽文件到此处或点击选择文件</p>
                        <input type="file" @change="handleFileSelect" ref="fileInput" multiple style="display: none;">
                        <button @click="$refs.fileInput.click()" class="select-btn">选择文件</button>
                    </div>
                    <div v-if="uploadFiles.length > 0" class="upload-list">
                        <h4>待上传文件:</h4>
                        <div v-for="(file, index) in uploadFiles" :key="index" class="upload-item">
                            <span>{{ file.name }} ({{ formatFileSize(file.size) }})</span>
                            <button @click="removeFile(index)" class="remove-btn">❌</button>
                        </div>
                        <button @click="uploadSelectedFiles" class="upload-submit-btn">🚀 开始上传</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文件预览模态框 -->
        <div v-if="showPreviewModal" class="modal-overlay" @click="showPreviewModal = false">
            <div class="modal preview-modal" @click.stop>
                <div class="modal-header">
                    <h3>👁️ 文件预览 - {{ previewFileData.filename }}</h3>
                    <button @click="showPreviewModal = false" class="close-btn">✖️</button>
                </div>
                <div class="modal-body">
                    <div v-if="isImageFile(previewFileData.filename)" class="image-preview">
                        <img :src="`/api/download?id=${previewFileData.id}`" :alt="previewFileData.filename" style="max-width: 100%; max-height: 500px;">
                    </div>
                    <div v-else-if="isVideoFile(previewFileData.filename)" class="video-preview">
                        <video controls style="max-width: 100%; max-height: 500px;">
                            <source :src="`/api/download?id=${previewFileData.id}`" :type="previewFileData.mime_type">
                            您的浏览器不支持视频预览
                        </video>
                    </div>
                    <div v-else-if="isTextFile(previewFileData.filename)" class="text-preview">
                        <pre>{{ previewContent }}</pre>
                    </div>
                    <div v-else class="unsupported-preview">
                        <div class="unsupported-icon">📄</div>
                        <p>{{ previewContent || '此文件类型不支持预览' }}</p>
                        <button @click="downloadFile(previewFileData)" class="download-btn">💾 下载查看</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 消息提示 -->
        <div v-if="message" :class="['message', message.type]" @click="message = null">
            {{ message.text }}
        </div>
    </div>

    <script src="/js/app.js"></script>
</body>
</html> 
</html> 